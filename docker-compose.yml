version: "3.9"

x-web-common: &web-common
  image: linky-web
  build: .
  env_file: .env
  volumes:
    - .:/app
    - staticfiles:/app/staticfiles
    - media:/app/media
    - db_data:/app/data
    - app_logs:/var/log/linky
  expose:
    - "8000"

services:
  web_blue:
    <<: *web-common

  web_green:
    <<: *web-common

  nginx:
    image: nginx:1.25-alpine
    depends_on:
      - web_blue
      - web_green
    env_file: .env
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf.template:/etc/nginx/templates/default.conf.template:ro
      - staticfiles:/app/staticfiles:ro
      - media:/app/media:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    restart: unless-stopped

volumes:
  staticfiles:
  media:
  db_data:
  app_logs:
